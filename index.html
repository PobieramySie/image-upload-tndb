<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Divyaa & Tarun</title>
  <link href="https://fonts.googleapis.com/css2?family=Corinthia&family=Lato&family=Mrs+Saint+Delafield&family=Playfair+Display&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Lato', sans-serif;
      background-image: url("paper-bg.jpg");
      background-repeat: repeat;
      background-size: auto;
      background-color: #f4f1ea;
      color: #1F2A35;
      text-align: center;
      padding: 2rem;
      margin: 0;
    }
    h1 {
      font-family: 'Corinthia', cursive;
      font-size: 4.5em;
      color: #3C4B33;
      margin-bottom: 0.5em;
      font-weight: 100;
    }
    p {
      font-family: 'Playfair Display', serif;
      max-width: 600px;
      margin: 0 auto 2em;
      font-size: 1.1em;
      color: #7A3B3A;
    }
    .button {
      display: inline-block;
      background-color: #B88380;
      color: #7A3B3A;
      padding: 12px 28px;
      margin: 0.5em;
      border: none;
      border-radius: 30px;
      font-size: 1em;
      cursor: pointer;
      text-decoration: none;
      transition: background 0.3s;
      font-family: 'Lato', sans-serif;
    }
    .button:hover {
      background-color: #9A5A58;
    }
    footer {
      margin-top: 3rem;
      font-size: 0.8em;
      color: #7A3B3A;
    }
    @media (max-width: 600px) {
      h1 {
        font-size: 3.5em;
      }
      .button {
        width: 80%;
      }
    }

    /* Loading screen styles */
    #loadingScreen {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(255, 255, 255, 0.9);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 9999;
    }
    #uploadProgress {
      width: 300px;
      height: 20px;
    }
  </style>
</head>
<body>

  <h1>Divyaa & Tarun</h1>
  
  <p>
    Thank you for sharing these special days with us. You can share your photos below or view beautiful moments captured by others.
  </p>

  <a href="#" onclick="document.getElementById('fileInput').click();" class="button">Upload photos or videos</a>
  <a href="gallery.html" class="button">View Gallery</a>

  <input type="file" id="fileInput" accept="image/*,video/*" multiple style="display:none" onchange="uploadFiles()" />

  <!-- Loading screen -->
  <div id="loadingScreen">
    <p>Uploading... <span id="progressPercent">0%</span></p>
    <progress id="uploadProgress" value="0" max="100"></progress>
  </div>

  <footer>
    After a succesful upload, you will see a confirmation message. Thank you for the memories!
  </footer>

  <script>
  const API_URL = 'https://gallery-api-jennifer-1000866423573.europe-west1.run.app';
    
  /***https://gallery-api-dbtn-1000866423573.europe-west1.run.app';***/

  async function uploadFiles() {
    const input = document.getElementById('fileInput');
    const files = input.files;
    if (!files.length) return;

    const loadingScreen = document.getElementById('loadingScreen');
    const progressBar = document.getElementById('uploadProgress');
    const progressText = document.getElementById('progressPercent');

    loadingScreen.style.display = 'flex';
    progressBar.value = 0;
    progressText.textContent = '0%';

    try {
      const uploadedUrls = [];

      // Calculate total size of all files
      const totalBytes = Array.from(files).reduce((sum, file) => sum + file.size, 0);
      let uploadedBytes = 0;

      // For each file, request a signed URL and upload
      for (const file of files) {
        const response = await fetch(`${API_URL}/generate-signed-url`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            filename: file.name,
            contentType: file.type || 'application/octet-stream',
          }),
        });

        if (!response.ok) throw new Error('Failed to generate an upload URL.');

        const { signedUrl, publicUrl } = await response.json();

        // Upload file and track progress
        await new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          xhr.open('PUT', signedUrl);
          xhr.setRequestHeader('Content-Type', file.type || 'application/octet-stream');

          let previousLoaded = 0;

          xhr.upload.onprogress = (event) => {
            if (event.lengthComputable) {
              const delta = event.loaded - previousLoaded;
              previousLoaded = event.loaded;

              uploadedBytes += delta;

              const percent = Math.min(Math.round((uploadedBytes / totalBytes) * 100), 100);
              progressBar.value = percent;
              progressText.textContent = `${percent}%`;

              console.log(`[DEBUG] Uploading ${file.name}: +${delta} bytes → ${uploadedBytes}/${totalBytes} → ${percent}%`);
            }
          };

          xhr.onload = () => {
            if (xhr.status === 200 || xhr.status === 201) {
              resolve();
            } else {
              reject(new Error(`Upload failed with status ${xhr.status}`));
            }
          };

          xhr.onerror = () => reject(new Error('Network error occured during upload.'));
          xhr.send(file);
        });

        uploadedUrls.push(publicUrl);
      }

      loadingScreen.style.display = 'none';
      input.value = '';
      alert('Uploaded files:\n' + uploadedUrls.join('\n'));

      progressBar.value = 0;
      progressText.textContent = '0%';

    } catch (err) {
      loadingScreen.style.display = 'none';
      console.error(err);
      alert('Upload error: ' + err.message);
    }
  }

  // Optional: warn before leaving if uploading
  window.onbeforeunload = function () {
    if (document.getElementById('loadingScreen').style.display === 'flex') {
      return 'Your upload is in progress. Do you want to exit the page?';
    }
  };
  </script>

</body>
</html>
